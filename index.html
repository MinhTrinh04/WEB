<!DOCTYPE html>
<html>
  <head>
    <title>React CRUD - Step 7</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
      }
      th {
        background-color: #f2f2f2;
      }
      .form {
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
      }
      .form div {
        margin-bottom: 5px;
      }
      .form label {
        display: inline-block;
        width: 80px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      function SearchForm({ onChangeValue }) {
        return (
          <input
            type="text"
            placeholder="Tìm theo name, username"
            onChange={(e) => onChangeValue(e.target.value)}
            style={{ marginBottom: "10px" }}
          />
        );
      }

      function AddUser({ onAdd }) {
        const [adding, setAdding] = React.useState(false);
        const [user, setUser] = React.useState({
          name: "",
          username: "",
          email: "",
          address: { street: "", suite: "", city: "" },
          phone: "",
          website: "",
        });

        const handleChange = (e) => {
          const { id, value } = e.target;
          if (["street", "suite", "city"].includes(id)) {
            setUser((prev) => ({
              ...prev,
              address: { ...prev.address, [id]: value },
            }));
          } else {
            setUser((prev) => ({
              ...prev,
              [id]: value,
            }));
          }
        };

        const handleAdd = () => {
          if (user.name === "" || user.username === "") {
            alert("Vui lòng nhập Name và Username!");
            return;
          }
          onAdd(user);
          setUser({
            name: "",
            username: "",
            email: "",
            address: { street: "", suite: "", city: "" },
            phone: "",
            website: "",
          });
          setAdding(false);
        };

        if (!adding) {
          return <button onClick={() => setAdding(true)}>Thêm</button>;
        }

        return (
          <div className="form">
            <h4>Thêm người dùng</h4>
            <div>
              <label htmlFor="name">Name:</label>
              <input
                id="name"
                type="text"
                value={user.name}
                onChange={handleChange}
              />
            </div>
            <div>
              <label htmlFor="username">Username:</label>
              <input
                id="username"
                type="text"
                value={user.username}
                onChange={handleChange}
              />
            </div>
            <div>
              <label htmlFor="email">Email:</label>
              <input
                id="email"
                type="text"
                value={user.email}
                onChange={handleChange}
              />
            </div>
            <div>
              <label htmlFor="city">City:</label>
              <input
                id="city"
                type="text"
                value={user.address.city}
                onChange={handleChange}
              />
            </div>
            <button onClick={handleAdd}>Lưu</button>
            <button onClick={() => setAdding(false)}>Hủy</button>
            <hr />
          </div>
        );
      }

      function ResultTable({ keyword, user, onAdded }) {
        const [users, setUsers] = React.useState([]);
        const [loading, setLoading] = React.useState(true);
        const [editing, setEditing] = React.useState(null);

        React.useEffect(() => {
          fetch("https://jsonplaceholder.typicode.com/users")
            .then((res) => res.json())
            .then((data) => {
              setUsers(data);
              setLoading(false);
            });
        }, []);

        React.useEffect(() => {
          if (user) {
            setUsers((prev) => [...prev, { ...user, id: prev.length + 1 }]);
            onAdded();
          }
        }, [user]);

        const editUser = (user) => {
          setEditing({ ...user, address: { ...user.address } });
        };

        const saveUser = () => {
          setUsers((prev) =>
            prev.map((u) => (u.id === editing.id ? editing : u))
          );
          setEditing(null);
        };

        const removeUser = (id) => {
          setUsers((prev) => prev.filter((u) => u.id !== id));
        };

        const handleEditChange = (e) => {
          const { id, value } = e.target;
          if (["street", "suite", "city"].includes(id)) {
            setEditing((prev) => ({
              ...prev,
              address: { ...prev.address, [id]: value },
            }));
          } else {
            setEditing((prev) => ({
              ...prev,
              [id]: value,
            }));
          }
        };

        const filteredUsers = users.filter(
          (u) =>
            u.name.toLowerCase().includes(keyword.toLowerCase()) ||
            u.username.toLowerCase().includes(keyword.toLowerCase())
        );

        if (loading) {
          return <p>Loading...</p>;
        }

        return (
          <div>
            {editing && (
              <div className="form">
                <h4>Sửa người dùng (ID: {editing.id})</h4>
                <div>
                  <label htmlFor="name">Name:</label>
                  <input
                    id="name"
                    type="text"
                    value={editing.name}
                    onChange={handleEditChange}
                  />
                </div>
                <div>
                  <label htmlFor="username">Username:</label>
                  <input
                    id="username"
                    type="text"
                    value={editing.username}
                    onChange={handleEditChange}
                  />
                </div>
                <div>
                  <label htmlFor="email">Email:</label>
                  <input
                    id="email"
                    type="text"
                    value={editing.email}
                    onChange={handleEditChange}
                  />
                </div>
                <div>
                  <label htmlFor="city">City:</label>
                  <input
                    id="city"
                    type="text"
                    value={editing.address.city}
                    onChange={handleEditChange}
                  />
                </div>
                <button onClick={saveUser}>Lưu thay đổi</button>
                <button onClick={() => setEditing(null)}>Hủy</button>
                <hr />
              </div>
            )}

            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>City</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {filteredUsers.map((u) => (
                  <tr key={u.id}>
                    <td>{u.id}</td>
                    <td>{u.name}</td>
                    <td>{u.username}</td>
                    <td>{u.email}</td>
                    <td>{u.address.city}</td>
                    <td>
                      <button onClick={() => editUser(u)}>Sửa</button>
                      <button onClick={() => removeUser(u.id)}>Xóa</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }

      function App() {
        const [kw, setKeyword] = React.useState("");
        const [newUser, setNewUser] = React.useState(null);

        return (
          <div>
            <h1>Quản lý người dùng</h1>
            <SearchForm onChangeValue={setKeyword} />
            <AddUser onAdd={setNewUser} />
            <ResultTable
              keyword={kw}
              user={newUser}
              onAdded={() => setNewUser(null)}
            />
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
