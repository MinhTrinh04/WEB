<!DOCTYPE html>
<html>
  <head>
    <title>React CRUD - Step 8 (Final)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      :root {
        --nau-cafe: #7a5b43;
        --vang-be: #dfcebb;
        --trang-sua: #f0e9da;
        --text-dark: #333;
        --white: #ffffff;
        --danger: #d9534f;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: var(--trang-sua);
        color: var(--text-dark);
        padding: 20px;
      }

      h1,
      h4 {
        color: var(--nau-cafe);
      }

      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
        background-color: var(--white);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      th,
      td {
        border: 1px solid var(--vang-be);
        padding: 10px;
        text-align: left;
      }

      th {
        background-color: var(--vang-be);
        color: var(--nau-cafe);
      }

      input[type="text"] {
        padding: 8px;
        border: 1px solid var(--vang-be);
        border-radius: 4px;
        width: calc(100% - 18px);
      }

      button {
        background-color: var(--nau-cafe);
        color: var(--white);
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
        font-weight: bold;
      }

      button:hover {
        opacity: 0.9;
      }

      button.btn-delete {
        background-color: var(--danger);
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
      }

      .modal-content {
        background: var(--white);
        padding: 20px;
        border-radius: 6px;
        width: 400px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: var(--nau-cafe);
      }

      .form-actions {
        margin-top: 20px;
        text-align: right;
      }

      .search-add-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .search-add-container input {
        width: 300px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      function SearchForm({ onChangeValue }) {
        return (
          <input
            type="text"
            placeholder="Tìm theo name, username"
            onChange={(e) => onChangeValue(e.target.value)}
          />
        );
      }

      function AddUser({ onAdd }) {
        const [adding, setAdding] = React.useState(false);
        const [user, setUser] = React.useState({
          name: "",
          username: "",
          email: "",
          address: { street: "", suite: "", city: "" },
          phone: "",
          website: "",
        });

        const handleChange = (e) => {
          const { id, value } = e.target;
          if (["street", "suite", "city"].includes(id)) {
            setUser((prev) => ({
              ...prev,
              address: { ...prev.address, [id]: value },
            }));
          } else {
            setUser((prev) => ({
              ...prev,
              [id]: value,
            }));
          }
        };

        const handleAdd = () => {
          if (user.name === "" || user.username === "") {
            alert("Vui lòng nhập Name và Username!");
            return;
          }
          onAdd(user);
          setUser({
            name: "",
            username: "",
            email: "",
            address: { street: "", suite: "", city: "" },
            phone: "",
            website: "",
          });
          setAdding(false);
        };

        return (
          <div>
            <button onClick={() => setAdding(true)}>Thêm người dùng</button>
            {adding && (
              <div className="modal-overlay">
                <div className="modal-content">
                  <h4>Thêm người dùng</h4>
                  <div className="form-group">
                    <label htmlFor="name">Name:</label>
                    <input
                      id="name"
                      type="text"
                      value={user.name}
                      onChange={handleChange}
                    />
                  </div>
                  <div className="form-group">
                    <label htmlFor="username">Username:</label>
                    <input
                      id="username"
                      type="text"
                      value={user.username}
                      onChange={handleChange}
                    />
                  </div>
                  <div className="form-group">
                    <label htmlFor="email">Email:</label>
                    <input
                      id="email"
                      type="text"
                      value={user.email}
                      onChange={handleChange}
                    />
                  </div>
                  <div className="form-group">
                    <label htmlFor="city">City:</label>
                    <input
                      id="city"
                      type="text"
                      value={user.address.city}
                      onChange={handleChange}
                    />
                  </div>
                  <div className="form-actions">
                    <button onClick={handleAdd}>Lưu</button>
                    <button onClick={() => setAdding(false)}>Hủy</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      function ResultTable({ keyword, user, onAdded }) {
        const [users, setUsers] = React.useState([]);
        const [loading, setLoading] = React.useState(true);
        const [editing, setEditing] = React.useState(null);

        React.useEffect(() => {
          fetch("https://jsonplaceholder.typicode.com/users")
            .then((res) => res.json())
            .then((data) => {
              setUsers(data);
              setLoading(false);
            });
        }, []);

        React.useEffect(() => {
          if (user) {
            setUsers((prev) => [...prev, { ...user, id: prev.length + 1 }]);
            onAdded();
          }
        }, [user]);

        const editUser = (user) => {
          setEditing({ ...user, address: { ...user.address } });
        };

        const saveUser = () => {
          setUsers((prev) =>
            prev.map((u) => (u.id === editing.id ? editing : u))
          );
          setEditing(null);
        };

        const removeUser = (id) => {
          if (window.confirm("Bạn có chắc muốn xóa người dùng này?")) {
            setUsers((prev) => prev.filter((u) => u.id !== id));
          }
        };

        const handleEditChange = (e) => {
          const { id, value } = e.target;
          if (["street", "suite", "city"].includes(id)) {
            setEditing((prev) => ({
              ...prev,
              address: { ...prev.address, [id]: value },
            }));
          } else {
            setEditing((prev) => ({
              ...prev,
              [id]: value,
            }));
          }
        };

        const filteredUsers = users.filter(
          (u) =>
            u.name.toLowerCase().includes(keyword.toLowerCase()) ||
            u.username.toLowerCase().includes(keyword.toLowerCase())
        );

        if (loading) {
          return <p>Loading...</p>;
        }

        return (
          <div>
            {editing && (
              <div className="modal-overlay">
                <div className="modal-content">
                  <h4>Sửa người dùng (ID: {editing.id})</h4>
                  <div className="form-group">
                    <label htmlFor="name">Name:</label>
                    <input
                      id="name"
                      type="text"
                      value={editing.name}
                      onChange={handleEditChange}
                    />
                  </div>
                  <div className="form-group">
                    <label htmlFor="username">Username:</label>
                    <input
                      id="username"
                      type="text"
                      value={editing.username}
                      onChange={handleEditChange}
                    />
                  </div>
                  <div className="form-group">
                    <label htmlFor="email">Email:</label>
                    <input
                      id="email"
                      type="text"
                      value={editing.email}
                      onChange={handleEditChange}
                    />
                  </div>
                  <div className="form-group">
                    <label htmlFor="city">City:</label>
                    <input
                      id="city"
                      type="text"
                      value={editing.address.city}
                      onChange={handleEditChange}
                    />
                  </div>
                  <div className="form-actions">
                    <button onClick={saveUser}>Lưu thay đổi</button>
                    <button onClick={() => setEditing(null)}>Hủy</button>
                  </div>
                </div>
              </div>
            )}

            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>City</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {filteredUsers.map((u) => (
                  <tr key={u.id}>
                    <td>{u.id}</td>
                    <td>{u.name}</td>
                    <td>{u.username}</td>
                    <td>{u.email}</td>
                    <td>{u.address.city}</td>
                    <td>
                      <button onClick={() => editUser(u)}>Sửa</button>
                      <button
                        className="btn-delete"
                        onClick={() => removeUser(u.id)}
                      >
                        Xóa
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      }

      function App() {
        const [kw, setKeyword] = React.useState("");
        const [newUser, setNewUser] = React.useState(null);

        return (
          <div>
            <h1>Quản lý người dùng</h1>
            <div className="search-add-container">
              <SearchForm onChangeValue={setKeyword} />
              <AddUser onAdd={setNewUser} />
            </div>
            <ResultTable
              keyword={kw}
              user={newUser}
              onAdded={() => setNewUser(null)}
            />
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
